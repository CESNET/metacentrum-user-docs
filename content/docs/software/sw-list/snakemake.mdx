---
title: Snakemake
---
<Callout  type="warn" title="Snakemake is not a module">
Snakemake is not installed system-wide as a module. This page collects just a few best practices concerning the data workflow within the MetaCentrum *storage - scratchdir - frontend* context. 
</Callout>

[Snakemake](https://snakemake.github.io) is a workflow management system for creating reproducible and scalable data analyses. Workflows are described via a human readable, Python-based language. They can be seamlessly scaled to server, cluster, grid and cloud environments, without the need to modify the workflow definition. Snakemake workflows can entail a description of required software, which will be automatically deployed to any execution environment.

## Installation

Due to Python compatibility, the recommended way to install Snakemake is in a separated [Mamba/Conda](./mamba) environment:

```bash
(BOOKWORM)user_123@skirit:~$ module add mambaforge
(BOOKWORM)user_123@skirit:~$ mamba create -n snakemake -c conda-forge -c bioconda snakemake
(BOOKWORM)user_123@skirit:~$ mamba activate snakemake
(snakemake) (BOOKWORM)user_123@skirit:~$ 
```

## Temporary files

If there are (large/many) temporary files generated within the Snakemake pipeline (e.g. when using `segemehl` sequence aligner), they should not be copied to/from Snakemake's default working directory in user's home. Instead, you should keep them in SCRATCHDIR and copy only the input and output files. 

### `shadow` rules usage 

One possibility to do this is [shadow rule](https://snakemake.readthedocs.io/en/stable/snakefiles/rules.html#shadow-rules).

For example;

```bash
rule segemehl:
    input:
      fastq="{sample}_trim_collapsed.fastq.gz",
      sege_idx="hg19.segemehl.idx",
    output:
      sam="{sample}_sege.sam",
    shadow: "minimal"
    shell: "segemehl.x -S -D 2 -M 1 --briefcigar -t 4 -i {input.sege_idx} -d {FA} -q {input.fastq}  > {output.sam}"
```

together with

```bash
snakemake --shadow-prefix $SCRATCHDIR --snakefile Snakefile  ...
```

### `tmpdir` variable usage

The Snakemake `tmpdir` resource automatically leads to setting the `$TMPDIR` (or $TEMP, or $TMP) variable for shell commands, scripts, wrappers and notebooks. The tmpdir resource is automatically used by shell commands, scripts and wrappers to store temporary data. If this argument is not specified at all, Snakemake just uses the tmpdir resource as outlined above. The tmpdir resource can also be overwritten either in a rule, or system-wide.

Define `tmpdir` per rule: 

```bash
rule segemehl:
    input:
      fastq="{sample}_trim_collapsed.fastq.gz",
      sege_idx="hg19.segemehl.idx",
    output:
      sam="{sample}_sege.sam",
    resources: tmpdir="${SCRATCHDIR}"
    shell: "segemehl.x -S -D 2 -M 1 --briefcigar -t 4 -i {input.sege_idx} -d {FA} -q {input.fastq}  > {output.sam}"
```

Define `tmpdir` workflow-wide:

```bash
snakemake --resources tmpdir=${SCRATCHDIR} --snakefile Snakefile  ...
```

